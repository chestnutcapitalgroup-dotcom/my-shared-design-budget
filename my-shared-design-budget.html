<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              'primary-900': '#1f2937',
              'primary-800': '#2d3748',
              'accent': '#4f46e5',
            },
          }
        }
      }
    </script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .task-item {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      .task-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    </style>
</head>
<body class="bg-primary-900 text-gray-100 min-h-screen flex items-center justify-center p-4">
  <main class="w-full max-w-2xl bg-primary-800 rounded-2xl shadow-2xl p-6 flex flex-col gap-6 fade-in">
    <div class="flex justify-between items-center">
      <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">Task Manager</h1>
      <div id="userIdDisplay" class="text-xs sm:text-sm text-gray-400 font-mono bg-primary-900 px-3 py-1 rounded-full">
        Loading...
      </div>
    </div>
    
    <div id="loadingIndicator" class="text-center py-10 text-gray-400 font-semibold text-lg">
      Loading tasks...
    </div>

    <div id="mainContent" class="hidden flex flex-col gap-4">
      <!-- Task input form -->
      <form id="taskForm" class="flex flex-col sm:flex-row gap-4">
        <input id="taskInput" type="text" placeholder="Add a new task..." 
               class="flex-grow p-3 rounded-xl bg-primary-900 border border-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent">
        <button type="submit" 
                class="bg-accent text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-500 transition duration-300 ease-in-out shadow-lg">
          Add Task
        </button>
      </form>

      <!-- Task list will be rendered here -->
      <ul id="taskList" class="flex flex-col gap-3">
        <!-- Tasks will be dynamically added here -->
      </ul>
    </div>
  </main>

  <!-- Firebase CDN imports -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithCustomToken, 
        signInAnonymously, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        updateDoc, 
        deleteDoc, 
        doc, 
        onSnapshot, 
        query,
        orderBy,
        setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables (Canvas Environment) ---
    // The following variables are provided by the canvas environment.
    // We use fallbacks for local development.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let firebaseConfig = {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- DOM Elements ---
    const loadingIndicator = document.getElementById('loadingIndicator');
    const mainContent = document.getElementById('mainContent');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const taskForm = document.getElementById('taskForm');
    const taskInput = document.getElementById('taskInput');
    const taskList = document.getElementById('taskList');

    // --- Helper Functions ---
    // Function to display the user's ID on the UI
    const displayUserId = (id) => {
        userIdDisplay.textContent = `User ID: ${id}`;
    };

    // Function to hide the loading state and show the main content
    const showApp = () => {
        loadingIndicator.classList.add('hidden');
        mainContent.classList.remove('hidden');
    };

    // Function to render tasks from Firestore
    const renderTasks = (tasks) => {
        taskList.innerHTML = '';
        tasks.forEach(task => {
            const li = document.createElement('li');
            li.className = `task-item bg-primary-900 rounded-xl p-4 flex items-center justify-between shadow-md ${task.completed ? 'opacity-50' : ''}`;
            
            const taskText = document.createElement('span');
            taskText.textContent = task.text;
            taskText.className = `flex-grow text-lg truncate ${task.completed ? 'line-through text-gray-500' : 'text-gray-100'}`;

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = "flex gap-2 ml-4";

            // Complete button
            const completeBtn = document.createElement('button');
            completeBtn.textContent = task.completed ? 'Uncomplete' : 'Complete';
            completeBtn.className = `px-3 py-1 text-sm rounded-full font-medium transition duration-300 ease-in-out ${task.completed ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'} text-white`;
            completeBtn.onclick = async () => {
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, task.id), {
                    completed: !task.completed
                });
            };

            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = "px-3 py-1 text-sm rounded-full font-medium bg-red-500 hover:bg-red-600 text-white transition duration-300 ease-in-out";
            deleteBtn.onclick = async () => {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, task.id));
            };

            buttonsContainer.appendChild(completeBtn);
            buttonsContainer.appendChild(deleteBtn);

            li.appendChild(taskText);
            li.appendChild(buttonsContainer);
            taskList.appendChild(li);
        });
    };

    // --- Main Authentication & Data Fetching Logic ---
    let app, auth, db, userId;

    try {
        if (typeof __firebase_config === 'undefined' || !__firebase_config) {
            throw new Error('Firebase configuration is missing or invalid.');
        }
        firebaseConfig = JSON.parse(__firebase_config);
        
        if (!firebaseConfig.apiKey) {
            throw new Error('Firebase apiKey is missing from the configuration.');
        }

        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        setLogLevel('debug');
        console.log("Firebase initialized successfully.");

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User authenticated:", userId);
                displayUserId(userId);
                showApp();

                // Set up a real-time listener for the tasks collection
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/tasks`));
                onSnapshot(q, (querySnapshot) => {
                    const tasks = [];
                    querySnapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    renderTasks(tasks);
                    console.log("Tasks updated.");
                }, (error) => {
                    console.error("Error fetching tasks:", error);
                    document.getElementById('loadingIndicator').textContent = 'Error: Failed to load tasks.';
                });

                // Handle new task submission
                taskForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const taskText = taskInput.value.trim();
                    if (taskText) {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tasks`), {
                            text: taskText,
                            completed: false,
                            createdAt: new Date()
                        });
                        taskInput.value = '';
                        console.log("Task added:", taskText);
                    }
                };
            } else {
                console.log("No user signed in. Attempting to sign in with token or anonymously.");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    document.getElementById('loadingIndicator').textContent = 'Error: Authentication failed.';
                }
            }
        });
    } catch (error) {
        console.error("Failed to initialize Firebase:", error);
        loadingIndicator.innerHTML = `
            <div class="text-center p-4 rounded-lg bg-red-800 text-white font-semibold">
                Error: Failed to initialize Firebase. <br>
                ${error.message}<br>
            </div>
            <div class="mt-4 text-xs text-gray-500 font-mono">
                Check the console for more details.
            </div>
        `;
    }
  </script>
</body>
</html>
